<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Phillip Alday">

<title>Mixed Effects Models in Julia – Introduction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01-intro.html">MixedModels.jl</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Mixed Effects Models in Julia</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">MixedModels.jl</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-plotting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-extensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extension Packages</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-bootstrap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bootstrap</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-wilkinson-notation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Formula Syntax</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#a-first-model" id="toc-a-first-model" class="nav-link active" data-scroll-target="#a-first-model">A first model</a></li>
  <li><a href="#examining-model-output" id="toc-examining-model-output" class="nav-link" data-scroll-target="#examining-model-output">Examining model output</a>
  <ul class="collapse">
  <li><a href="#optimization-results" id="toc-optimization-results" class="nav-link" data-scroll-target="#optimization-results">Optimization results</a></li>
  <li><a href="#best-linear-unbiased-predictions" id="toc-best-linear-unbiased-predictions" class="nav-link" data-scroll-target="#best-linear-unbiased-predictions">Best linear unbiased predictions</a></li>
  <li><a href="#measures-of-model-fit" id="toc-measures-of-model-fit" class="nav-link" data-scroll-target="#measures-of-model-fit">Measures of model fit</a></li>
  </ul></li>
  <li><a href="#predicting-new-data" id="toc-predicting-new-data" class="nav-link" data-scroll-target="#predicting-new-data">Predicting new data</a></li>
  <li><a href="#constructing-more-complex-models" id="toc-constructing-more-complex-models" class="nav-link" data-scroll-target="#constructing-more-complex-models">Constructing more complex models</a></li>
  <li><a href="#how-big-can-we-go" id="toc-how-big-can-we-go" class="nav-link" data-scroll-target="#how-big-can-we-go">How big can we go?</a>
  <ul class="collapse">
  <li><a href="#memory-allocation-vs.-fitting" id="toc-memory-allocation-vs.-fitting" class="nav-link" data-scroll-target="#memory-allocation-vs.-fitting">Memory allocation vs.&nbsp;fitting</a></li>
  <li><a href="#to-try-on-your-own-after-the-course" id="toc-to-try-on-your-own-after-the-course" class="nav-link" data-scroll-target="#to-try-on-your-own-after-the-course">To try on your own after the course</a></li>
  </ul></li>
  <li><a href="#generalized-linear-mixed-effects-models" id="toc-generalized-linear-mixed-effects-models" class="nav-link" data-scroll-target="#generalized-linear-mixed-effects-models">Generalized Linear Mixed Effects Models</a></li>
  <li><a href="#limitations-of-mixedmodels.jl" id="toc-limitations-of-mixedmodels.jl" class="nav-link" data-scroll-target="#limitations-of-mixedmodels.jl">Limitations of MixedModels.jl</a>
  <ul class="collapse">
  <li><a href="#very-few-options-for-covariance-structure" id="toc-very-few-options-for-covariance-structure" class="nav-link" data-scroll-target="#very-few-options-for-covariance-structure">Very few options for covariance structure</a></li>
  <li><a href="#no-support-for-sandwichrobust-variance-covariance-estimators" id="toc-no-support-for-sandwichrobust-variance-covariance-estimators" class="nav-link" data-scroll-target="#no-support-for-sandwichrobust-variance-covariance-estimators">No support for sandwich/robust variance-covariance estimators</a></li>
  <li><a href="#no-support-for-generalized-linear-mixed-models-with-a-dispersion-parameter" id="toc-no-support-for-generalized-linear-mixed-models-with-a-dispersion-parameter" class="nav-link" data-scroll-target="#no-support-for-generalized-linear-mixed-models-with-a-dispersion-parameter">No support for generalized linear mixed models with a dispersion parameter</a></li>
  <li><a href="#no-support-for-polytomous-responses" id="toc-no-support-for-polytomous-responses" class="nav-link" data-scroll-target="#no-support-for-polytomous-responses">No support for polytomous responses</a></li>
  <li><a href="#no-support-for-regularization-of-the-fixed-effects" id="toc-no-support-for-regularization-of-the-fixed-effects" class="nav-link" data-scroll-target="#no-support-for-regularization-of-the-fixed-effects">No support for regularization of the fixed effects</a></li>
  <li><a href="#no-support-for-generalized-additive-mixed-models" id="toc-no-support-for-generalized-additive-mixed-models" class="nav-link" data-scroll-target="#no-support-for-generalized-additive-mixed-models">No support for generalized additive mixed models</a></li>
  <li><a href="#no-support-for-nonlinear-mixed-effects-models" id="toc-no-support-for-nonlinear-mixed-effects-models" class="nav-link" data-scroll-target="#no-support-for-nonlinear-mixed-effects-models">No support for nonlinear mixed effects models</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/palday/economics2024/edit/main/01-intro.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/palday/economics2024/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Introduction</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Phillip Alday <a href="mailto:me@phillipalday.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-9984-5745" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>MixedModels.jl is part of the JuliaStats ecosystem and so shares a number of interface and design elements with GLM.jl. MixedModels.jl can also be viewed as the next step in the research programme behind the R package lme4 (and further back, nlme). The focus of development is on linear mixed effects models with unconstrained covariance matrices, with a secondary focus on generalized linear mixed effects models. We’ll come back to this focus later, when we discuss limitations of the software. For now, let us start off with a simple mixed model.</p>
<section id="a-first-model" class="level1">
<h1>A first model</h1>
<p>MixedModels.jl ships with a number of sample and testing datasets, with varying levels of documentation.</p>
<div id="2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MixedModels</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>MixedModels.<span class="fu">datasets</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>17-element Vector{String}:
 "cbpp"
 "contra"
 "d3"
 "dyestuff"
 "dyestuff2"
 "grouseticks"
 "insteval"
 "kb07"
 "machines"
 "ml1m"
 "mmec"
 "mrk17_exp1"
 "oxide"
 "pastes"
 "penicillin"
 "sleepstudy"
 "verbagg"</code></pre>
</div>
</div>
<p>Let’s take a look at <code>insteval</code>, which is the same dataset <a href="https://rdrr.io/cran/lme4/man/InstEval.html">documented in lme4</a>.</p>
<div id="4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>insteval <span class="op">=</span> MixedModels.<span class="fu">dataset</span>(<span class="st">"insteval"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Arrow.Table with 73421 rows, 7 columns, and schema:
 :s        String
 :d        String
 :dept     String
 :studage  String
 :lectage  String
 :service  String
 :y        Int8</code></pre>
</div>
</div>
<ul>
<li><code>s</code>: individual students (2972 values)</li>
<li><code>d</code>: individual instructors (from <em>Dozent</em>, 2160 values)</li>
<li><code>studage</code>: student “age” measured in their current semester number</li>
<li><code>lectage</code>: lecture “age”, measuring how many semesters back the lecture rated had taken place (this was part of a retrospective study, so some ratings were from a few years back)</li>
<li><code>service</code>: whether or not the lecture is held as a “service” in a different department</li>
<li><code>dept</code>: department (15 unique values)</li>
</ul>
<div id="6" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fm1 <span class="op">=</span> <span class="fu">fit</span>(MixedModel,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>          <span class="pp">@formula</span>(y <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> studage <span class="op">+</span> lectage <span class="op">+</span> service <span class="op">+</span> (<span class="fl">1</span><span class="op">|</span>s) <span class="op">+</span> (<span class="fl">1</span><span class="op">|</span>d) <span class="op">+</span> (<span class="fl">1</span><span class="op">|</span>dept)),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>          insteval; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: right;" data-quarto-table-cell-role="th">Est.</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">SE</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">z</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">p</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_s</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_d</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_dept</td>
</tr>
<tr class="even">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">3.2908</td>
<td style="text-align: right;">0.0324</td>
<td style="text-align: right;">101.45</td>
<td style="text-align: right;">&lt;1e-99</td>
<td style="text-align: right;">0.3264</td>
<td style="text-align: right;">0.5106</td>
<td style="text-align: right;">0.0787</td>
</tr>
<tr class="odd">
<td style="text-align: left;">studage: 4</td>
<td style="text-align: right;">0.0519</td>
<td style="text-align: right;">0.0232</td>
<td style="text-align: right;">2.24</td>
<td style="text-align: right;">0.0249</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">studage: 6</td>
<td style="text-align: right;">0.0721</td>
<td style="text-align: right;">0.0240</td>
<td style="text-align: right;">3.01</td>
<td style="text-align: right;">0.0026</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">studage: 8</td>
<td style="text-align: right;">0.1363</td>
<td style="text-align: right;">0.0264</td>
<td style="text-align: right;">5.17</td>
<td style="text-align: right;">&lt;1e-06</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 2</td>
<td style="text-align: right;">-0.0808</td>
<td style="text-align: right;">0.0154</td>
<td style="text-align: right;">-5.25</td>
<td style="text-align: right;">&lt;1e-06</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">lectage: 3</td>
<td style="text-align: right;">-0.1102</td>
<td style="text-align: right;">0.0167</td>
<td style="text-align: right;">-6.59</td>
<td style="text-align: right;">&lt;1e-10</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 4</td>
<td style="text-align: right;">-0.1892</td>
<td style="text-align: right;">0.0196</td>
<td style="text-align: right;">-9.65</td>
<td style="text-align: right;">&lt;1e-21</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">lectage: 5</td>
<td style="text-align: right;">-0.1644</td>
<td style="text-align: right;">0.0214</td>
<td style="text-align: right;">-7.68</td>
<td style="text-align: right;">&lt;1e-13</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 6</td>
<td style="text-align: right;">-0.2460</td>
<td style="text-align: right;">0.0205</td>
<td style="text-align: right;">-12.01</td>
<td style="text-align: right;">&lt;1e-32</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">service: Y</td>
<td style="text-align: right;">-0.0727</td>
<td style="text-align: right;">0.0135</td>
<td style="text-align: right;">-5.40</td>
<td style="text-align: right;">&lt;1e-07</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Residual</td>
<td style="text-align: right;">1.1762</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Note that we don’t need to convert the sample dataset into a DataFrame: there is a standard for tabular data in Julia and MixedModels.jl can consume any table meeting that standard. This can be very useful for large datasets, when having an additional copy of the data in memory can be costly, and also allows for using memory mapped tabular structures.</p>
<p>For display in the Quarto notebook, we set <code>progress=false</code>, but the progress meter defaults to enabled. For a given model, you may nonetheless not see the progress meter if the model is finished fitting before the first progress update would be delivered.</p>
</section>
<section id="examining-model-output" class="level1">
<h1>Examining model output</h1>
<p>We note that MixedModels.jl has a different display in the REPL than it does in an Markdown/HTML/LaTeX document. Packages are free to define <code>show</code> methods for displaying their output different for different output venues (i.e.&nbsp;for different MIME types). We can force the plaintext output with <code>println</code>:</p>
<div id="8" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by maximum likelihood
 y ~ 1 + studage + lectage + service + (1 | s) + (1 | d) + (1 | dept)
    logLik     -2 logLik       AIC         AICc          BIC     
 -118776.9929  237553.9858  237581.9858  237581.9915  237710.8413

Variance components:
            Column   Variance Std.Dev. 
s        (Intercept)  0.106519 0.326372
d        (Intercept)  0.260721 0.510608
dept     (Intercept)  0.006192 0.078691
Residual              1.383337 1.176153
 Number of obs: 73421; levels of grouping factors: 2972, 1128, 14

  Fixed-effects parameters:
─────────────────────────────────────────────────────
                  Coef.  Std. Error       z  Pr(&gt;|z|)
─────────────────────────────────────────────���───────
(Intercept)   3.29078     0.032436   101.45    &lt;1e-99
studage: 4    0.0519477   0.0231671    2.24    0.0249
studage: 6    0.0721226   0.0239626    3.01    0.0026
studage: 8    0.136285    0.0263766    5.17    &lt;1e-06
lectage: 2   -0.080753    0.0153803   -5.25    &lt;1e-06
lectage: 3   -0.110187    0.0167235   -6.59    &lt;1e-10
lectage: 4   -0.189168    0.0196016   -9.65    &lt;1e-21
lectage: 5   -0.16443     0.0214044   -7.68    &lt;1e-13
lectage: 6   -0.245996    0.020484   -12.01    &lt;1e-32
service: Y   -0.0727166   0.0134729   -5.40    &lt;1e-07
─────────────────────────────────────────────────────</code></pre>
</div>
</div>
<p>The default pretty printing method for HTML output shows less information than the default output in the REPL, but represents a compact way to display many elements in a single table. We can also extract the individual elements:</p>
<div id="10" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="fu">coeftable</span>(fm1)) <span class="co"># the fixed effects</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>─────────────────────────────────────────────────────
                  Coef.  Std. Error       z  Pr(&gt;|z|)
──────────────────────────────────��──────────────────
(Intercept)   3.29078     0.032436   101.45    &lt;1e-99
studage: 4    0.0519477   0.0231671    2.24    0.0249
studage: 6    0.0721226   0.0239626    3.01    0.0026
studage: 8    0.136285    0.0263766    5.17    &lt;1e-06
lectage: 2   -0.080753    0.0153803   -5.25    &lt;1e-06
lectage: 3   -0.110187    0.0167235   -6.59    &lt;1e-10
lectage: 4   -0.189168    0.0196016   -9.65    &lt;1e-21
lectage: 5   -0.16443     0.0214044   -7.68    &lt;1e-13
lectage: 6   -0.245996    0.020484   -12.01    &lt;1e-32
service: Y   -0.0727166   0.0134729   -5.40    &lt;1e-07
─────────────────────────────────────────────────────</code></pre>
</div>
</div>
<div id="12" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="fu">VarCorr</span>(fm1)) <span class="co"># the variance-covariance, i.e. random effect, estimates</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variance components:
            Column   Variance Std.Dev. 
s        (Intercept)  0.106519 0.326372
d        (Intercept)  0.260721 0.510608
dept     (Intercept)  0.006192 0.078691
Residual              1.383337 1.176153
</code></pre>
</div>
</div>
<p>Notably, each of these components also has a pretty printing method defined for rich displays.</p>
<section id="optimization-results" class="level2">
<h2 class="anchored" data-anchor-id="optimization-results">Optimization results</h2>
<p>For more technically oriented users and debugging problematic models, the fitted model also includes information about its fit:</p>
<div id="14" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fm1.optsum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Initialization</strong></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Initial parameter vector</td>
<td style="text-align: left;">[1.0, 1.0, 1.0]</td>
</tr>
<tr class="even">
<td style="text-align: left;">Initial objective value</td>
<td style="text-align: left;">241905.85361894369</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Optimizer settings</strong></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Optimizer (from NLopt)</td>
<td style="text-align: left;"><code>LN_BOBYQA</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Lower bounds</td>
<td style="text-align: left;">[0.0, 0.0, 0.0]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ftol_rel</code></td>
<td style="text-align: left;">1.0e-12</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ftol_abs</code></td>
<td style="text-align: left;">1.0e-8</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>xtol_rel</code></td>
<td style="text-align: left;">0.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>xtol_abs</code></td>
<td style="text-align: left;">[1.0e-10, 1.0e-10, 1.0e-10]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>initial_step</code></td>
<td style="text-align: left;">[0.75, 0.75, 0.75]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>maxfeval</code></td>
<td style="text-align: left;">-1</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>maxtime</code></td>
<td style="text-align: left;">-1.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Result</strong></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Function evaluations</td>
<td style="text-align: left;">97</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Final parameter vector</td>
<td style="text-align: left;">[0.2775, 0.4341, 0.0669]</td>
</tr>
<tr class="even">
<td style="text-align: left;">Final objective value</td>
<td style="text-align: left;">237553.9858</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Return code</td>
<td style="text-align: left;"><code>FTOL_REACHED</code></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="best-linear-unbiased-predictions" class="level2">
<h2 class="anchored" data-anchor-id="best-linear-unbiased-predictions">Best linear unbiased predictions</h2>
<p>We can also examine the best linear unbiased predictions (BLUPS, i.e.&nbsp;conditional modes) of the fitted model:</p>
<div id="16" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gives a compact mathematical representation</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ranef</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>3-element Vector{Matrix{Float64}}:
 [0.16774123178334052 -0.04482694183068773 … 0.13824421252672484 0.26507732678861823]
 [0.38719882629204333 -0.45435181953200804 … 0.5663054833894617 -0.2322561040271726]
 [0.01925158595457121 -0.0314237380877306 … -0.0394324632568055 0.010868838311276535]</code></pre>
</div>
</div>
<div id="18" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gives a NamedTuple of tables for each grouping variable</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>re <span class="op">=</span> <span class="fu">raneftables</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(s = @NamedTuple{s::String, (Intercept)::Float64}[(s = "S0001", var"(Intercept)" = 0.16774123178334052), (s = "S0002", var"(Intercept)" = -0.04482694183068773), (s = "S0003", var"(Intercept)" = 0.31575885609970306), (s = "S0004", var"(Intercept)" = 0.24940695145339822), (s = "S0005", var"(Intercept)" = 0.05086330189212764), (s = "S0006", var"(Intercept)" = 0.10070570655847189), (s = "S0007", var"(Intercept)" = 0.49346335551085657), (s = "S0008", var"(Intercept)" = 0.21230052405523037), (s = "S0009", var"(Intercept)" = 0.43329760696045716), (s = "S0010", var"(Intercept)" = 0.3474382457376265)  …  (s = "S2963", var"(Intercept)" = -0.07493268898885441), (s = "S2964", var"(Intercept)" = -0.07639875902063552), (s = "S2965", var"(Intercept)" = -0.01269753658773821), (s = "S2966", var"(Intercept)" = -0.05968365555624512), (s = "S2967", var"(Intercept)" = -0.47762073203601624), (s = "S2968", var"(Intercept)" = -0.03808065216440611), (s = "S2969", var"(Intercept)" = 0.013164293735230988), (s = "S2970", var"(Intercept)" = 0.15284750426572696), (s = "S2971", var"(Intercept)" = 0.13824421252672484), (s = "S2972", var"(Intercept)" = 0.26507732678861823)], d = @NamedTuple{d::String, (Intercept)::Float64}[(d = "I0001", var"(Intercept)" = 0.38719882629204333), (d = "I0006", var"(Intercept)" = -0.45435181953200804), (d = "I0007", var"(Intercept)" = 0.6941269521055441), (d = "I0008", var"(Intercept)" = -0.6556986845555067), (d = "I0012", var"(Intercept)" = 0.2232265515513102), (d = "I0013", var"(Intercept)" = 0.35851586978902583), (d = "I0014", var"(Intercept)" = 0.3672805427901967), (d = "I0015", var"(Intercept)" = -0.37841197668279464), (d = "I0017", var"(Intercept)" = 0.4490422906985483), (d = "I0018", var"(Intercept)" = -0.21303124506473872)  …  (d = "I2143", var"(Intercept)" = 0.46453745653954004), (d = "I2145", var"(Intercept)" = -0.5103188066752637), (d = "I2146", var"(Intercept)" = 0.24093975571844684), (d = "I2147", var"(Intercept)" = -0.60947032761476), (d = "I2149", var"(Intercept)" = -0.2569371800839588), (d = "I2152", var"(Intercept)" = -0.1486343267392193), (d = "I2153", var"(Intercept)" = -0.4582448890911759), (d = "I2156", var"(Intercept)" = -0.598164389730049), (d = "I2157", var"(Intercept)" = 0.5663054833894617), (d = "I2160", var"(Intercept)" = -0.2322561040271726)], dept = @NamedTuple{dept::String, (Intercept)::Float64}[(dept = "D01", var"(Intercept)" = 0.01925158595457121), (dept = "D02", var"(Intercept)" = -0.0314237380877306), (dept = "D03", var"(Intercept)" = 0.026989756564498747), (dept = "D04", var"(Intercept)" = 0.08634883593136969), (dept = "D05", var"(Intercept)" = 0.0425384283501927), (dept = "D06", var"(Intercept)" = -0.0612386105577639), (dept = "D07", var"(Intercept)" = 0.037994105160680386), (dept = "D08", var"(Intercept)" = 0.10706977660601054), (dept = "D09", var"(Intercept)" = -0.03130386231393186), (dept = "D10", var"(Intercept)" = -0.13074749481062195), (dept = "D11", var"(Intercept)" = -0.05345274044982538), (dept = "D12", var"(Intercept)" = 0.016537582598079168), (dept = "D14", var"(Intercept)" = -0.0394324632568055), (dept = "D15", var"(Intercept)" = 0.010868838311276535)])</code></pre>
</div>
</div>
<div id="20" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>re[<span class="op">:</span>dept]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Table with 2 columns and 14 rows:
      dept  (Intercept)
    ┌──────────────────
 1  │ D01   0.0192516
 2  │ D02   -0.0314237
 3  │ D03   0.0269898
 4  │ D04   0.0863488
 5  │ D05   0.0425384
 6  │ D06   -0.0612386
 7  │ D07   0.0379941
 8  │ D08   0.10707
 9  │ D09   -0.0313039
 10 │ D10   -0.130747
 11 │ D11   -0.0534527
 12 │ D12   0.0165376
 13 │ D14   -0.0394325
 14 │ D15   0.0108688</code></pre>
</div>
</div>
<p>Similarly, <code>condVar</code> and <code>condVartables</code> provide similar results for the conditional variances, which can be used to construct prediction intervals. Note that this quantity is slightly more challenging to compute, so the next code chunk can be quite slow for large and/or complex models.</p>
<div id="22" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> <span class="fu">condVartables</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(s = (s = ["S0001", "S0002", "S0003", "S0004", "S0005", "S0006", "S0007", "S0008", "S0009", "S0010"  …  "S2963", "S2964", "S2965", "S2966", "S2967", "S2968", "S2969", "S2970", "S2971", "S2972"], σ = [(0.2858669689270982,), (0.30401631752599356,), (0.22821157590283608,), (0.25780032906103995,), (0.2860219499541289,), (0.25793951955717076,), (0.26490082020646233,), (0.2783368253958202,), (0.2522473463464451,), (0.22880831550861952,)  …  (0.20261426533573362,), (0.15345460348688958,), (0.1890606491627694,), (0.2364492114093623,), (0.16864266061743807,), (0.13248230048424514,), (0.21568690433796606,), (0.15989932548370614,), (0.19703921571219082,), (0.17611120732728797,)], ρ = [(), (), (), (), (), (), (), (), (), ()  …  (), (), (), (), (), (), (), (), (), ()]), d = (d = ["I0001", "I0006", "I0007", "I0008", "I0012", "I0013", "I0014", "I0015", "I0017", "I0018"  …  "I2143", "I2145", "I2146", "I2147", "I2149", "I2152", "I2153", "I2156", "I2157", "I2160"], σ = [(0.2944722990101209,), (0.1998490792256777,), (0.1976067001224343,), (0.15270441118675238,), (0.2050062557300713,), (0.18323918475417014,), (0.20826372508991525,), (0.1379768365880709,), (0.09916344786890752,), (0.25898396366164883,)  …  (0.27099005487450534,), (0.278560313176016,), (0.2642024787031552,), (0.11352578408559302,), (0.2148321233886452,), (0.28061080140124645,), (0.21640468799848833,), (0.26558809165790237,), (0.18875484054677152,), (0.12464395110737535,)], ρ = [(), (), (), (), (), (), (), (), (), ()  …  (), (), (), (), (), (), (), (), (), ()]), dept = (dept = ["D01", "D02", "D03", "D04", "D05", "D06", "D07", "D08", "D09", "D10", "D11", "D12", "D14", "D15"], σ = [(0.05342275258013416,), (0.05695221129282561,), (0.05309362315152055,), (0.04189159945771541,), (0.05536549244050585,), (0.04470905986933437,), (0.053575423476545404,), (0.05037317159100928,), (0.05202142805811866,), (0.047679287077604354,), (0.0522411612413694,), (0.04219045746979842,), (0.052986775032521645,), (0.048625616226665495,)], ρ = [(), (), (), (), (), (), (), (), (), (), (), (), (), ()]))</code></pre>
</div>
</div>
<div id="24" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this output still isn't pretty, but we're working on it!</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>cv[<span class="op">:</span>dept]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(dept = ["D01", "D02", "D03", "D04", "D05", "D06", "D07", "D08", "D09", "D10", "D11", "D12", "D14", "D15"], σ = [(0.05342275258013416,), (0.05695221129282561,), (0.05309362315152055,), (0.04189159945771541,), (0.05536549244050585,), (0.04470905986933437,), (0.053575423476545404,), (0.05037317159100928,), (0.05202142805811866,), (0.047679287077604354,), (0.0522411612413694,), (0.04219045746979842,), (0.052986775032521645,), (0.048625616226665495,)], ρ = [(), (), (), (), (), (), (), (), (), (), (), (), (), ()])</code></pre>
</div>
</div>
<p>At this point, it becomes convenient to place everything into a dataframe so that we can easily manipulate the relevant quantities.</p>
<div id="26" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dept <span class="op">=</span> <span class="fu">DataFrame</span>(cv[<span class="op">:</span>dept])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>14×3 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">dept</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">σ</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ρ</th>
</tr>
<tr class="odd subheader headerLastRow">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Tuple{Float64}">Tuple…</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Tuple{}">Tuple{}</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">D01</td>
<td style="text-align: left;">(0.0534228,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">D02</td>
<td style="text-align: left;">(0.0569522,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">D03</td>
<td style="text-align: left;">(0.0530936,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: left;">D04</td>
<td style="text-align: left;">(0.0418916,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: left;">D05</td>
<td style="text-align: left;">(0.0553655,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">6</td>
<td style="text-align: left;">D06</td>
<td style="text-align: left;">(0.0447091,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">7</td>
<td style="text-align: left;">D07</td>
<td style="text-align: left;">(0.0535754,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">8</td>
<td style="text-align: left;">D08</td>
<td style="text-align: left;">(0.0503732,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">9</td>
<td style="text-align: left;">D09</td>
<td style="text-align: left;">(0.0520214,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">10</td>
<td style="text-align: left;">D10</td>
<td style="text-align: left;">(0.0476793,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">11</td>
<td style="text-align: left;">D11</td>
<td style="text-align: left;">(0.0522412,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">12</td>
<td style="text-align: left;">D12</td>
<td style="text-align: left;">(0.0421905,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">13</td>
<td style="text-align: left;">D14</td>
<td style="text-align: left;">(0.0529868,)</td>
<td style="text-align: left;">()</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">14</td>
<td style="text-align: left;">D15</td>
<td style="text-align: left;">(0.0486256,)</td>
<td style="text-align: left;">()</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Let’s construct prediction intervals:</p>
<div id="28" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select!</span>(dept, <span class="op">:</span>dept, <span class="op">:</span>σ <span class="op">=&gt;</span> <span class="fu">ByRow</span>(first) <span class="op">=&gt;</span> <span class="op">:</span>condvar)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">leftjoin!</span>(dept, <span class="fu">DataFrame</span>(re[<span class="op">:</span>dept]); on<span class="op">=:</span>dept)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>14×3 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">dept</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">condvar</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">(Intercept)</th>
</tr>
<tr class="odd subheader headerLastRow">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Union{Missing, Float64}">Float64?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">D01</td>
<td style="text-align: right;">0.0534228</td>
<td style="text-align: right;">0.0192516</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">D02</td>
<td style="text-align: right;">0.0569522</td>
<td style="text-align: right;">-0.0314237</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">D03</td>
<td style="text-align: right;">0.0530936</td>
<td style="text-align: right;">0.0269898</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: left;">D04</td>
<td style="text-align: right;">0.0418916</td>
<td style="text-align: right;">0.0863488</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: left;">D05</td>
<td style="text-align: right;">0.0553655</td>
<td style="text-align: right;">0.0425384</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">6</td>
<td style="text-align: left;">D06</td>
<td style="text-align: right;">0.0447091</td>
<td style="text-align: right;">-0.0612386</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">7</td>
<td style="text-align: left;">D07</td>
<td style="text-align: right;">0.0535754</td>
<td style="text-align: right;">0.0379941</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">8</td>
<td style="text-align: left;">D08</td>
<td style="text-align: right;">0.0503732</td>
<td style="text-align: right;">0.10707</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">9</td>
<td style="text-align: left;">D09</td>
<td style="text-align: right;">0.0520214</td>
<td style="text-align: right;">-0.0313039</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">10</td>
<td style="text-align: left;">D10</td>
<td style="text-align: right;">0.0476793</td>
<td style="text-align: right;">-0.130747</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">11</td>
<td style="text-align: left;">D11</td>
<td style="text-align: right;">0.0522412</td>
<td style="text-align: right;">-0.0534527</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">12</td>
<td style="text-align: left;">D12</td>
<td style="text-align: right;">0.0421905</td>
<td style="text-align: right;">0.0165376</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">13</td>
<td style="text-align: left;">D14</td>
<td style="text-align: right;">0.0529868</td>
<td style="text-align: right;">-0.0394325</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">14</td>
<td style="text-align: left;">D15</td>
<td style="text-align: right;">0.0486256</td>
<td style="text-align: right;">0.0108688</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="30" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select!</span>(dept, <span class="st">"dept"</span>, <span class="st">"(Intercept)"</span> <span class="op">=&gt;</span> <span class="st">"blup"</span>, <span class="st">"condvar"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(dept,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>           [<span class="op">:</span>blup, <span class="op">:</span>condvar] <span class="op">=&gt;</span> <span class="fu">ByRow</span>((x,y) <span class="op">-&gt;</span> x <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> y) <span class="op">=&gt;</span> <span class="op">:</span>lower,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>           [<span class="op">:</span>blup, <span class="op">:</span>condvar] <span class="op">=&gt;</span> <span class="fu">ByRow</span>((x,y) <span class="op">-&gt;</span> x <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> y) <span class="op">=&gt;</span> <span class="op">:</span>upper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>14×5 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">dept</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">blup</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">condvar</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">lower</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">upper</th>
</tr>
<tr class="odd subheader headerLastRow">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Union{Missing, Float64}">Float64?</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">D01</td>
<td style="text-align: right;">0.0192516</td>
<td style="text-align: right;">0.0534228</td>
<td style="text-align: right;">-0.085457</td>
<td style="text-align: right;">0.12396</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">D02</td>
<td style="text-align: right;">-0.0314237</td>
<td style="text-align: right;">0.0569522</td>
<td style="text-align: right;">-0.14305</td>
<td style="text-align: right;">0.0802026</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">D03</td>
<td style="text-align: right;">0.0269898</td>
<td style="text-align: right;">0.0530936</td>
<td style="text-align: right;">-0.0770737</td>
<td style="text-align: right;">0.131053</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: left;">D04</td>
<td style="text-align: right;">0.0863488</td>
<td style="text-align: right;">0.0418916</td>
<td style="text-align: right;">0.0042413</td>
<td style="text-align: right;">0.168456</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: left;">D05</td>
<td style="text-align: right;">0.0425384</td>
<td style="text-align: right;">0.0553655</td>
<td style="text-align: right;">-0.0659779</td>
<td style="text-align: right;">0.151055</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">6</td>
<td style="text-align: left;">D06</td>
<td style="text-align: right;">-0.0612386</td>
<td style="text-align: right;">0.0447091</td>
<td style="text-align: right;">-0.148868</td>
<td style="text-align: right;">0.0263911</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">7</td>
<td style="text-align: left;">D07</td>
<td style="text-align: right;">0.0379941</td>
<td style="text-align: right;">0.0535754</td>
<td style="text-align: right;">-0.0670137</td>
<td style="text-align: right;">0.143002</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">8</td>
<td style="text-align: left;">D08</td>
<td style="text-align: right;">0.10707</td>
<td style="text-align: right;">0.0503732</td>
<td style="text-align: right;">0.00833836</td>
<td style="text-align: right;">0.205801</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">9</td>
<td style="text-align: left;">D09</td>
<td style="text-align: right;">-0.0313039</td>
<td style="text-align: right;">0.0520214</td>
<td style="text-align: right;">-0.133266</td>
<td style="text-align: right;">0.0706581</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">10</td>
<td style="text-align: left;">D10</td>
<td style="text-align: right;">-0.130747</td>
<td style="text-align: right;">0.0476793</td>
<td style="text-align: right;">-0.224199</td>
<td style="text-align: right;">-0.0372961</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">11</td>
<td style="text-align: left;">D11</td>
<td style="text-align: right;">-0.0534527</td>
<td style="text-align: right;">0.0522412</td>
<td style="text-align: right;">-0.155845</td>
<td style="text-align: right;">0.0489399</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">12</td>
<td style="text-align: left;">D12</td>
<td style="text-align: right;">0.0165376</td>
<td style="text-align: right;">0.0421905</td>
<td style="text-align: right;">-0.0661557</td>
<td style="text-align: right;">0.0992309</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">13</td>
<td style="text-align: left;">D14</td>
<td style="text-align: right;">-0.0394325</td>
<td style="text-align: right;">0.0529868</td>
<td style="text-align: right;">-0.143287</td>
<td style="text-align: right;">0.0644216</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">14</td>
<td style="text-align: left;">D15</td>
<td style="text-align: right;">0.0108688</td>
<td style="text-align: right;">0.0486256</td>
<td style="text-align: right;">-0.0844374</td>
<td style="text-align: right;">0.106175</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="measures-of-model-fit" class="level2">
<h2 class="anchored" data-anchor-id="measures-of-model-fit">Measures of model fit</h2>
<p>MixedModels.jl provides methods for the standard functions <code>aic</code>, <code>aicc</code>, <code>bic</code>, <code>deviance</code>, <code>fitted</code>, <code>logliklihood</code>, <code>nobs</code>, <code>residuals</code>.</p>
<p>The deviance is computed as <code>-2 loglikelihood</code> and is thus missing an additive constant for the saturated model. However, defining that constant is challenging for mixed models (what is the saturated model? do you saturate via the fixed or the random effects?) and that constant cancels out in the relevant computations.</p>
<p>MixedModels.jl intentionally does not provide methods for <code>r2</code> and <code>adjr2</code>. These quantities are <a href="https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-summaries-goodness-of-fit-decomposition-of-variance-etc.">notoriously difficult to define in a completely satisfactory way for mixed models</a> and we, the developers, felt uncomfortable giving our implicit endorsement by defining them as part of the core package. That said, there is an implementation of a naive definition of the coefficient of determination in <a href="https://palday.github.io/MixedModelsExtras.jl/v2/api/#Coefficient-of-Determination">MixedModelsExtras.jl</a> because it is a commonly requested measure and I felt that it was better to have a well-tested implementation than have users handroll their own buggy implementation of an already problematic measure.</p>
</section>
</section>
<section id="predicting-new-data" class="level1">
<h1>Predicting new data</h1>
<p>The <code>predict</code> function can be used to generate predictions on new data. As an initial sanity check, we can consider the case of predicting from the original data – this should yield the fitted values:</p>
<div id="32" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fm1, insteval) <span class="op">≈</span> <span class="fu">fitted</span>(fm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>true</code></pre>
</div>
</div>
<p>The <code>predict</code> function supports three different options for handling new levels of the grouping variable:</p>
<ul>
<li><code>:population</code>: return population values for the relevant grouping variable. In other words, treat the associated random effect as 0. If all grouping variables have new levels, then this is equivalent to just the fixed effects.</li>
<li><code>:missing</code>: return <code>missing</code>.</li>
<li><code>:error</code>: error on this condition.</li>
</ul>
<p>For example, we can construct a novel dataset based on the first row of the insteval data.</p>
<div id="34" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="fu">first</span>(<span class="fu">DataFrame</span>(insteval), <span class="fl">2</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>df[!, <span class="op">:</span>s] <span class="op">.=</span> <span class="st">"new"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>2×7 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">s</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">d</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">dept</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">studage</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">lectage</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">service</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">y</th>
</tr>
<tr class="odd subheader headerLastRow">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int8">Int8</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">new</td>
<td style="text-align: left;">I1002</td>
<td style="text-align: left;">D02</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">N</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">new</td>
<td style="text-align: left;">I1050</td>
<td style="text-align: left;">D06</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Y</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="36" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fm1, df; new_re_levels<span class="op">=:</span>population)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2-element Vector{Float64}:
 2.9786264818180572
 2.996608317331572</code></pre>
</div>
</div>
<div id="38" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fm1, df; new_re_levels<span class="op">=:</span><span class="cn">missing</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2-element Vector{Union{Missing, Float64}}:
 missing
 missing</code></pre>
</div>
</div>
<div id="40" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fm1, df; new_re_levels<span class="op">=:</span>error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre>ArgumentError: New level encountered in s
Stacktrace:
 [1] <span class="ansi-bold">_predict</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">m</span>::LinearMixedModel<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">newdata</span>::@NamedTuple<span class="ansi-bright-black-fg">{s::Vector{String}, d::Vector{String}, dept::Vector{String}, studage::Vector{String}, lectage::Vector{String}, service::Vector{String}, y::Vector{Int8}}</span>, <span class="ansi-bright-black-fg">β</span>::Vector<span class="ansi-bright-black-fg">{Float64}</span>; <span class="ansi-bright-black-fg">new_re_levels</span>::Symbol<span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">   @</span> <span class="ansi-magenta-fg">MixedModels</span> <span class="ansi-bright-black-fg">~/.julia/packages/MixedModels/NBPpG/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">predict.jl:148</span>
 [2] <span class="ansi-bold">_predict</span>
<span class="ansi-bright-black-fg">   @</span> <span class="ansi-bright-black-fg">~/.julia/packages/MixedModels/NBPpG/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">predict.jl:91</span><span class="ansi-bright-black-fg"> [inlined]</span>
 [3] <span class="ansi-bold">predict</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">m</span>::LinearMixedModel<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">newdata</span>::@NamedTuple<span class="ansi-bright-black-fg">{s::Vector{String}, d::Vector{String}, dept::Vector{String}, studage::Vector{String}, lectage::Vector{String}, service::Vector{String}, y::Vector{Int8}}</span>; <span class="ansi-bright-black-fg">new_re_levels</span>::Symbol<span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">   @</span> <span class="ansi-magenta-fg">MixedModels</span> <span class="ansi-bright-black-fg">~/.julia/packages/MixedModels/NBPpG/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">predict.jl:73</span>
 [4] <span class="ansi-bold">predict</span><span class="ansi-bold">(</span><span class="ansi-bright-black-fg">m</span>::LinearMixedModel<span class="ansi-bright-black-fg">{Float64}</span>, <span class="ansi-bright-black-fg">newdata</span>::DataFrame; <span class="ansi-bright-black-fg">kwargs</span>::@Kwargs<span class="ansi-bright-black-fg">{new_re_levels::Symbol}</span><span class="ansi-bold">)</span>
<span class="ansi-bright-black-fg">   @</span> <span class="ansi-magenta-fg">MixedModels</span> <span class="ansi-bright-black-fg">~/.julia/packages/MixedModels/NBPpG/src/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">predict.jl:220</span>
 [5] top-level scope
<span class="ansi-bright-black-fg">   @</span> <span class="ansi-bright-black-fg">~/Work/economics2024/</span><span style="text-decoration:underline" class="ansi-bright-black-fg">01-intro.qmd:164</span></pre>
</div>
</div>
</div>
<p>Similarly, the <code>simulate</code> function can be used to simulate new data and will draw a new sample from the estimated random effects distribution:</p>
<div id="42" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">simulate</span>(<span class="fu">MersenneTwister</span>(<span class="fl">42</span>), fm1, df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2-element Vector{Float64}:
 3.4358332592451757
 1.9761875079220057</code></pre>
</div>
</div>
</section>
<section id="constructing-more-complex-models" class="level1">
<h1>Constructing more complex models</h1>
<p>We now consider a few more complicated models to examine a few further extensions to the syntax. Including additional varying slopes is as easy as adding them before the relevant grouping variable:</p>
<div id="44" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fm2 <span class="op">=</span> <span class="fu">fit</span>(MixedModel,</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>          <span class="pp">@formula</span>(y <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> studage <span class="op">+</span> lectage <span class="op">+</span> service <span class="op">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">|</span> s) <span class="op">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">+</span> service <span class="op">|</span> d) <span class="op">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">+</span> service <span class="op">|</span> dept)),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>          insteval; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: right;" data-quarto-table-cell-role="th">Est.</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">SE</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">z</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">p</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_s</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_d</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_dept</td>
</tr>
<tr class="even">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">3.2985</td>
<td style="text-align: right;">0.0307</td>
<td style="text-align: right;">107.27</td>
<td style="text-align: right;">&lt;1e-99</td>
<td style="text-align: right;">0.3242</td>
<td style="text-align: right;">0.5160</td>
<td style="text-align: right;">0.0642</td>
</tr>
<tr class="odd">
<td style="text-align: left;">studage: 4</td>
<td style="text-align: right;">0.0502</td>
<td style="text-align: right;">0.0232</td>
<td style="text-align: right;">2.16</td>
<td style="text-align: right;">0.0306</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">studage: 6</td>
<td style="text-align: right;">0.0573</td>
<td style="text-align: right;">0.0242</td>
<td style="text-align: right;">2.37</td>
<td style="text-align: right;">0.0180</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">studage: 8</td>
<td style="text-align: right;">0.1128</td>
<td style="text-align: right;">0.0268</td>
<td style="text-align: right;">4.21</td>
<td style="text-align: right;">&lt;1e-04</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 2</td>
<td style="text-align: right;">-0.0787</td>
<td style="text-align: right;">0.0156</td>
<td style="text-align: right;">-5.03</td>
<td style="text-align: right;">&lt;1e-06</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">lectage: 3</td>
<td style="text-align: right;">-0.1036</td>
<td style="text-align: right;">0.0169</td>
<td style="text-align: right;">-6.14</td>
<td style="text-align: right;">&lt;1e-09</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 4</td>
<td style="text-align: right;">-0.1837</td>
<td style="text-align: right;">0.0199</td>
<td style="text-align: right;">-9.21</td>
<td style="text-align: right;">&lt;1e-19</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">lectage: 5</td>
<td style="text-align: right;">-0.1503</td>
<td style="text-align: right;">0.0217</td>
<td style="text-align: right;">-6.94</td>
<td style="text-align: right;">&lt;1e-11</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 6</td>
<td style="text-align: right;">-0.2232</td>
<td style="text-align: right;">0.0209</td>
<td style="text-align: right;">-10.66</td>
<td style="text-align: right;">&lt;1e-25</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">service: Y</td>
<td style="text-align: right;">-0.0281</td>
<td style="text-align: right;">0.0498</td>
<td style="text-align: right;">-0.56</td>
<td style="text-align: right;">0.5732</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">0.3906</td>
<td style="text-align: right;">0.1640</td>
</tr>
<tr class="even">
<td style="text-align: left;">Residual</td>
<td style="text-align: right;">1.1698</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="46" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(fm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by maximum likelihood
 y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + (1 + service | dept)
    logLik     -2 logLik       AIC         AICc          BIC     
 -118578.6372  237157.2744  237193.2744  237193.2837  237358.9458

Variance components:
            Column    Variance  Std.Dev.   Corr.
s        (Intercept)  0.1051240 0.3242283
d        (Intercept)  0.2662938 0.5160367
         service: Y   0.1525375 0.3905605 -0.40
dept     (Intercept)  0.0041235 0.0642145
         service: Y   0.0268819 0.1639569 -0.71
Residual              1.3684549 1.1698098
 Number of obs: 73421; levels of grouping factors: 2972, 1128, 14

  Fixed-effects parameters:
─────────────────────────────────────────────────────
                  Coef.  Std. Error       z  Pr(&gt;|z|)
────────────────────────────────────────────────────���
(Intercept)   3.2985      0.0307497  107.27    &lt;1e-99
studage: 4    0.05022     0.0232292    2.16    0.0306
studage: 6    0.0572624   0.0242029    2.37    0.0180
studage: 8    0.112771    0.0267845    4.21    &lt;1e-04
lectage: 2   -0.0787344   0.0156461   -5.03    &lt;1e-06
lectage: 3   -0.103602    0.0168684   -6.14    &lt;1e-09
lectage: 4   -0.183664    0.0199353   -9.21    &lt;1e-19
lectage: 5   -0.150344    0.0216722   -6.94    &lt;1e-11
lectage: 6   -0.223191    0.0209329  -10.66    &lt;1e-25
service: Y   -0.0280727   0.0498258   -0.56    0.5732
─────────────────────────────────────────────────────</code></pre>
</div>
</div>
<p>Of course, we want to know whether this more complicated model has a better fit than our original model. To that end, we can use the <code>lrtest</code> function (same as in GLM.jl and originally part of the StatsAPI.jl specification):</p>
<div id="48" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MixedModels</span>: lrtest</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lrtest</span>(fm1, fm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Likelihood-ratio test: 2 models fitted on 73421 observations
──────────────────────────────────────────────────────────────
     DOF  ΔDOF        LogLik     Deviance     Chisq  p(&gt;Chisq)
──────────────────────────────────────────────────────────────
[1]   14        -118776.9929  237553.9858                     
[2]   18     4  -118578.6372  237157.2744  396.7114     &lt;1e-83
──────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
<p>The <code>lrtest</code> function is very general and as such has rather generic output. The checks it performs for nested models are also fairly conservative in the mixed models case – determining nesting of mixed models is not always trivial. MixedModels.jl also provides a <code>likelihoodratio</code> function that is a bit more specialized for mixed models and which performs a different, less conservative set of nesting checks:</p>
<div id="50" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MixedModels</span>: likelihoodratiotest</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">likelihoodratiotest</span>(fm1, fm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: right;" data-quarto-table-cell-role="th">model-dof</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">deviance</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">χ²</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">χ²-dof</td>
<td style="text-align: left;" data-quarto-table-cell-role="th">P(&gt;χ²)</td>
</tr>
<tr class="even">
<td style="text-align: left;">y ~ 1 + studage + lectage + service + (1 | s) + (1 | d) + (1 | dept)</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">237554</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + (1 + service | dept)</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">237157</td>
<td style="text-align: right;">397</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">&lt;1e-83</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can see that the display is different but that the computed quantities are indeed identical.</p>
<p>We can also consider an even more complicated model, where there is a varying effect of <code>studage</code> by <code>d</code>ozent – perhaps a particular instructor has a teaching style that is better for students at the beginning or end of their studies. However, <code>studage</code> is a categorical variable with four levels, so including it means that we would include three additional contrasts in the random effects. Together with the intercept and <code>service</code>, we would then have 6 * 5 / 2 = 15 correlation parameters to estimate, which dramatically increases model complexity. We can force the correlation parameters for a particular blocking variable to zero with <code>zerocorr</code>. Furthermore, if we include the same blocking variable multiple times, then the estimated correlations between the different occurrences are all forced to zero.</p>
<div id="52" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fm3 <span class="op">=</span> <span class="fu">fit</span>(MixedModel,</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>          <span class="pp">@formula</span>(y <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> studage <span class="op">+</span> lectage <span class="op">+</span> service <span class="op">+</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">|</span> s) <span class="op">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">+</span> service <span class="op">|</span> d) <span class="op">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">zerocorr</span>(<span class="fl">0</span> <span class="op">+</span> studage <span class="op">|</span> d) <span class="op">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">+</span> service <span class="op">|</span> dept)),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>          insteval; progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: right;" data-quarto-table-cell-role="th">Est.</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">SE</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">z</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">p</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_d</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_s</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_dept</td>
</tr>
<tr class="even">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">3.3081</td>
<td style="text-align: right;">0.0262</td>
<td style="text-align: right;">126.30</td>
<td style="text-align: right;">&lt;1e-99</td>
<td style="text-align: right;">0.5038</td>
<td style="text-align: right;">0.3234</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">studage: 4</td>
<td style="text-align: right;">0.0537</td>
<td style="text-align: right;">0.0277</td>
<td style="text-align: right;">1.94</td>
<td style="text-align: right;">0.0524</td>
<td style="text-align: right;">0.2700</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">studage: 6</td>
<td style="text-align: right;">0.0533</td>
<td style="text-align: right;">0.0265</td>
<td style="text-align: right;">2.01</td>
<td style="text-align: right;">0.0440</td>
<td style="text-align: right;">0.2077</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">studage: 8</td>
<td style="text-align: right;">0.1080</td>
<td style="text-align: right;">0.0293</td>
<td style="text-align: right;">3.68</td>
<td style="text-align: right;">0.0002</td>
<td style="text-align: right;">0.2544</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 2</td>
<td style="text-align: right;">-0.0861</td>
<td style="text-align: right;">0.0172</td>
<td style="text-align: right;">-5.01</td>
<td style="text-align: right;">&lt;1e-06</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">lectage: 3</td>
<td style="text-align: right;">-0.0979</td>
<td style="text-align: right;">0.0188</td>
<td style="text-align: right;">-5.22</td>
<td style="text-align: right;">&lt;1e-06</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 4</td>
<td style="text-align: right;">-0.1999</td>
<td style="text-align: right;">0.0218</td>
<td style="text-align: right;">-9.16</td>
<td style="text-align: right;">&lt;1e-19</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">lectage: 5</td>
<td style="text-align: right;">-0.1646</td>
<td style="text-align: right;">0.0231</td>
<td style="text-align: right;">-7.12</td>
<td style="text-align: right;">&lt;1e-11</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">lectage: 6</td>
<td style="text-align: right;">-0.2477</td>
<td style="text-align: right;">0.0221</td>
<td style="text-align: right;">-11.20</td>
<td style="text-align: right;">&lt;1e-28</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">service: Y</td>
<td style="text-align: right;">-0.0239</td>
<td style="text-align: right;">0.0436</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">0.5836</td>
<td style="text-align: right;">0.3703</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">0.1383</td>
</tr>
<tr class="even">
<td style="text-align: left;">Residual</td>
<td style="text-align: right;">1.1581</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Note that correlation that are systematically zero are shown with a <code>.</code> The estimated between-department variance for the intercept term has also dropped to zero, which leads to the associated correlation being <code>NaN</code>.</p>
<div id="54" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(fm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by maximum likelihood
 y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + zerocorr(0 + studage | d) + (1 + service | dept)
    logLik     -2 logLik       AIC         AICc          BIC     
 -118334.5047  236669.0093  236711.0093  236711.0219  236904.2926

Variance components:
            Column   Variance Std.Dev.   Corr.
d        (Intercept)  0.253836 0.503821
         service: Y   0.137154 0.370343 -0.40
         studage: 4   0.072918 0.270033   .     .  
         studage: 6   0.043119 0.207651   .     .     .  
         studage: 8   0.064741 0.254443   .     .     .     .  
s        (Intercept)  0.104601 0.323421
dept     (Intercept)  0.000000 0.000000
         service: Y   0.019118 0.138268  +NaN
Residual              1.341243 1.158121
 Number of obs: 73421; levels of grouping factors: 1128, 2972, 14

  Fixed-effects parameters:
───────────────────────��─────────────────────────────
                  Coef.  Std. Error       z  Pr(&gt;|z|)
─────────────────────────────────────────────────────
(Intercept)   3.3081      0.0261931  126.30    &lt;1e-99
studage: 4    0.0537457   0.027701     1.94    0.0524
studage: 6    0.0533209   0.0264708    2.01    0.0440
studage: 8    0.107955    0.0293241    3.68    0.0002
lectage: 2   -0.0861051   0.0171882   -5.01    &lt;1e-06
lectage: 3   -0.0979496   0.0187585   -5.22    &lt;1e-06
lectage: 4   -0.199903    0.0218116   -9.16    &lt;1e-19
lectage: 5   -0.164638    0.02313     -7.12    &lt;1e-11
lectage: 6   -0.247657    0.0221202  -11.20    &lt;1e-28
service: Y   -0.0238895   0.0435847   -0.55    0.5836
─────────────────────────────────────────────────────</code></pre>
</div>
</div>
<p>This additional model complexity is warranted in terms of goodness of fit:</p>
<div id="56" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">likelihoodratiotest</span>(fm2, fm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: right;" data-quarto-table-cell-role="th">model-dof</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">deviance</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">χ²</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">χ²-dof</td>
<td style="text-align: left;" data-quarto-table-cell-role="th">P(&gt;χ²)</td>
</tr>
<tr class="even">
<td style="text-align: left;">y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + (1 + service | dept)</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">237157</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + zerocorr(0 + studage | d) + (1 + service | dept)</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">236669</td>
<td style="text-align: right;">488</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">&lt;1e-99</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As a final note, we can also examine the effective dimensionality of the random effects with PCA <span class="citation" data-cites="bates:parsimonious:2018">(<a href="#ref-bates:parsimonious:2018" role="doc-biblioref">Bates et al., 2018</a>)</span>. The property <code>rePCA</code> displays the cumulative variance explained for each principle component of each variance component and thus an estimate of excess dimensionality:</p>
<div id="58" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fm2.rePCA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(s = [1.0], d = [0.699611383518749, 1.0], dept = [0.8552280055346075, 1.0])</code></pre>
</div>
</div>
<div id="60" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>fm3.rePCA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(d = [0.2802290720955171, 0.48022907209551713, 0.6802290720955171, 0.880229072095517, 1.0], s = [1.0], dept = [1.0, 1.0])</code></pre>
</div>
</div>
<p>Together with the estimated correlations, this suggests that we could reduce the complexity of the by-department random effects. (Given that there are only 15 levels of department, it is also not surprising that we are unable to estimate subtle between department effects.)</p>
<div id="62" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>fm4 <span class="op">=</span> <span class="fu">fit</span>(MixedModel,</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>          <span class="pp">@formula</span>(y <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> studage <span class="op">+</span> lectage <span class="op">+</span> service <span class="op">+</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">|</span> s) <span class="op">+</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">+</span> service <span class="op">|</span> d) <span class="op">+</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">zerocorr</span>(<span class="fl">0</span> <span class="op">+</span> studage <span class="op">|</span> d) <span class="op">+</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>                      (<span class="fl">1</span> <span class="op">|</span> dept)),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>          insteval; progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(fm4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by maximum likelihood
 y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + zerocorr(0 + studage | d) + (1 | dept)
    logLik     -2 logLik       AIC         AICc          BIC     
 -118344.9806  236689.9611  236727.9611  236727.9715  236902.8365

Variance components:
            Column    Variance  Std.Dev.   Corr.
d        (Intercept)  0.2511920 0.5011906
         service: Y   0.1548062 0.3934541 -0.39
         studage: 4   0.0734884 0.2710874   .     .  
         studage: 6   0.0429228 0.2071781   .     .     .  
         studage: 8   0.0641958 0.2533689   .     .     .     .  
s        (Intercept)  0.1046926 0.3235623
dept     (Intercept)  0.0041430 0.0643658
Residual              1.3412785 1.1581358
 Number of obs: 73421; levels of grouping factors: 1128, 2972, 14

  Fixed-effects parameters:
────────────────────────────────────────────────���────
                  Coef.  Std. Error       z  Pr(&gt;|z|)
─────────────────────────────────────────────────────
(Intercept)   3.30686     0.0315141  104.93    &lt;1e-99
studage: 4    0.0569021   0.0277368    2.05    0.0402
studage: 6    0.0590447   0.0264697    2.23    0.0257
studage: 8    0.116329    0.0293408    3.96    &lt;1e-04
lectage: 2   -0.0851793   0.017208    -4.95    &lt;1e-06
lectage: 3   -0.0995886   0.0187626   -5.31    &lt;1e-06
lectage: 4   -0.201518    0.0218214   -9.23    &lt;1e-19
lectage: 5   -0.1688      0.0231259   -7.30    &lt;1e-12
lectage: 6   -0.253875    0.0221082  -11.48    &lt;1e-29
service: Y   -0.0499552   0.0224018   -2.23    0.0257
─────────────────────────────────────────────────────</code></pre>
</div>
</div>
<div id="64" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">likelihoodratiotest</span>(fm3, fm4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: right;" data-quarto-table-cell-role="th">model-dof</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">deviance</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">χ²</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">χ²-dof</td>
<td style="text-align: left;" data-quarto-table-cell-role="th">P(&gt;χ²)</td>
</tr>
<tr class="even">
<td style="text-align: left;">y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + zerocorr(0 + studage | d) + (1 | dept)</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">236690</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">y ~ 1 + studage + lectage + service + (1 | s) + (1 + service | d) + zerocorr(0 + studage | d) + (1 + service | dept)</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">236669</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">&lt;1e-04</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="66" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>fm4.rePCA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(d = [0.278607454040941, 0.47860745404094096, 0.678607454040941, 0.8786074540409409, 1.0], s = [1.0], dept = [1.0])</code></pre>
</div>
</div>
</section>
<section id="how-big-can-we-go" class="level1">
<h1>How big can we go?</h1>
<p>The MovieLens data <span class="citation" data-cites="harper:2016">(<a href="#ref-harper:2016" role="doc-biblioref">Harper &amp; Konstan, 2016</a>)</span> contain millions of observations and provide a good stress test for model size and complexity.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The following models consume a large amount of memory because of the sheer size of the underlying dataset. Do <strong>not</strong> attempt to fit these models on a machine with less than 32GiB of memory.</p>
</div>
</div>
<p>See also the chapter <a href="https://embraceuncertaintybook.com/largescaleobserved.html">“A large-scale observational study” in our online book <em>Embrace Uncertainty</em></a>.</p>
<section id="memory-allocation-vs.-fitting" class="level2">
<h2 class="anchored" data-anchor-id="memory-allocation-vs.-fitting">Memory allocation vs.&nbsp;fitting</h2>
<div id="68" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Econ2024</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>ratings <span class="op">=</span> Econ2024.<span class="fu">dataset</span>(<span class="st">"ratings"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> fm_ratings <span class="op">=</span> <span class="fu">LinearMixedModel</span>(<span class="pp">@formula</span>(rating <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> (<span class="fl">1</span><span class="op">|</span>userId) <span class="op">+</span> (<span class="fl">1</span><span class="op">|</span>movieId)), ratings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="70" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="fu">fit!</span>(fm_ratings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="to-try-on-your-own-after-the-course" class="level2">
<h2 class="anchored" data-anchor-id="to-try-on-your-own-after-the-course">To try on your own after the course</h2>
<div id="72" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Econ2024</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>ratings <span class="op">=</span> <span class="fu">DataFrame</span>(Econ2024.<span class="fu">dataset</span>(<span class="st">"ratings_genre"</span>))</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(ratings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="74" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">StatsBase</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>mcount <span class="op">=</span> <span class="fu">countmap</span>(ratings.movieId)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>ucount <span class="op">=</span> <span class="fu">countmap</span>(ratings.userId)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>mexclude <span class="op">=</span> <span class="fu">Set</span>(k <span class="cf">for</span> (k, v) <span class="kw">in</span> <span class="fu">pairs</span>(mcount) <span class="cf">if</span> v <span class="op">&lt;</span> <span class="fl">50</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>uexclude <span class="op">=</span> <span class="fu">Set</span>(k <span class="cf">for</span> (k, v) <span class="kw">in</span> <span class="fu">pairs</span>(ucount) <span class="cf">if</span> v <span class="op">&lt;</span> <span class="fl">50</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>ratings <span class="op">=</span> <span class="fu">subset</span>(ratings,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                 <span class="op">:</span>movieId <span class="op">=&gt;</span> <span class="fu">ByRow</span>(!<span class="fu">in</span>(mexclude)),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                 <span class="op">:</span>userId <span class="op">=&gt;</span> <span class="fu">ByRow</span>(!<span class="fu">in</span>(uexclude)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="76" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes about an hour on my home computer when using the full dataset</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>form1 <span class="op">=</span> <span class="pp">@formula</span>(rating <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> Action <span class="op">+</span> Adventure <span class="op">+</span> Animation <span class="op">+</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                             Children <span class="op">+</span> Comedy <span class="op">+</span> Crime <span class="op">+</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                             Documentary <span class="op">+</span> Drama <span class="op">+</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                             Fantasy <span class="op">+</span> Film_Noir <span class="op">+</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                             Horror <span class="op">+</span> IMAX <span class="op">+</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                             Musical <span class="op">+</span> Mystery <span class="op">+</span> Romance <span class="op">+</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                             Sci_Fi <span class="op">+</span> Thriller <span class="op">+</span> War <span class="op">+</span> Western <span class="op">+</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                             (<span class="fl">1</span> <span class="op">|</span> movieId) <span class="op">+</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                             (<span class="fl">1</span> <span class="op">|</span> userId))</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fit</span>(MixedModel, form1, ratings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- # Saving and restoring fits -->
</section>
</section>
<section id="generalized-linear-mixed-effects-models" class="level1">
<h1>Generalized Linear Mixed Effects Models</h1>
<p>One of the test data sets from the Center for Multilevel Modelling, University of Bristol is derived from the 1989 Bangladesh Fertility Survey <span class="citation" data-cites="huq:cleland:1990">(<a href="#ref-huq:cleland:1990" role="doc-biblioref">Huq &amp; Cleland, 1990</a>)</span>. The data are a subsample of 1934 women selected from 60 of the 64 political districts or <em>zila</em>, available as the <code>contra</code> data set in the <code>MixedModels</code> package.</p>
<p>Variable in the dataset:</p>
<ul>
<li><code>use</code>, whether the woman chooses to use artificial contraception, with two possible values, <code>N</code> and <code>Y</code></li>
<li><code>dist</code>, district in which the woman resides</li>
<li><code>livch</code>, the number of live children she currently has, coded as <code>0</code>, <code>1</code>, <code>2</code>, and <code>3+</code></li>
<li><code>age</code>, in years, but pre-centered and rounded, with the original center not available</li>
<li><code>urban</code>, coded as <code>N</code> and <code>Y</code>, indicating rural or urban.</li>
</ul>
<div id="78" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>contra <span class="op">=</span> MixedModels.<span class="fu">dataset</span>(<span class="op">:</span>contra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Arrow.Table with 1934 rows, 5 columns, and schema:
 :dist   String
 :urban  String
 :livch  String
 :age    Float64
 :use    String</code></pre>
</div>
</div>
<p>In order to simplify the data a bit, we will also add a binary variable <code>anych</code> which indicates whether the woman has <em>any</em> children:</p>
<div id="80" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>contra <span class="op">=</span> <span class="fu">DataFrame</span>(contra)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>contra[!, <span class="op">:</span>anych] <span class="op">.=</span> contra[!, <span class="op">:</span>livch] <span class="op">.!=</span> <span class="st">"0"</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(contra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>6×7 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">min</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">max</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">nmissing</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">eltype</th>
</tr>
<tr class="odd subheader headerLastRow">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Symbol">Symbol</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Union{Nothing, Float64}">Union…</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Any">Any</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Union{Nothing, Float64}">Union…</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Any">Any</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="DataType">DataType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">dist</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">D01</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">D61</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">String</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">urban</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">N</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">Y</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">String</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">livch</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">0</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">3+</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">String</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: left;">age</td>
<td style="text-align: left;">0.00204757</td>
<td style="text-align: left;">-13.56</td>
<td style="text-align: left;">-1.56</td>
<td style="text-align: left;">19.44</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Float64</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: left;">use</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">N</td>
<td style="text-align: left; font-style: italic;"></td>
<td style="text-align: left;">Y</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">String</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">6</td>
<td style="text-align: left;">anych</td>
<td style="text-align: left;">0.725957</td>
<td style="text-align: left;">false</td>
<td style="text-align: left;">1.0</td>
<td style="text-align: left;">true</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Bool</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For a more principled examination of model building with this dataset, please refer to the <a href="https://embraceuncertaintybook.com/glmmbernoulli.html">chapter “Generalized linear mixed models for binary responses”</a> of <em>Embrace Uncertainty</em>.</p>
</div>
</div>
<p>We set some appropriate contrasts</p>
<div id="82" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>contrasts <span class="op">=</span> <span class="fu">Dict</span>(<span class="op">:</span>livch <span class="op">=&gt;</span> <span class="fu">HelmertCoding</span>(; base<span class="op">=</span><span class="st">"0"</span>),</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>                 <span class="op">:</span>urban <span class="op">=&gt;</span> <span class="fu">EffectsCoding</span>(),</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                 <span class="op">:</span>anych <span class="op">=&gt;</span> <span class="fu">EffectsCoding</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Dict{Symbol, StatsModels.AbstractContrasts} with 3 entries:
  :urban =&gt; EffectsCoding(nothing, nothing)
  :livch =&gt; HelmertCoding("0", nothing)
  :anych =&gt; EffectsCoding(nothing, nothing)</code></pre>
</div>
</div>
<p>and fit a model</p>
<div id="84" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>gm1 <span class="op">=</span> <span class="fu">fit</span>(MixedModel,</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>          <span class="pp">@formula</span>(use <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> urban <span class="op">+</span> anych <span class="op">*</span> age <span class="op">+</span> <span class="fu">abs2</span>(age) <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> dist <span class="op">&amp;</span> urban)),</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>          contra,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>          <span class="fu">Bernoulli</span>(),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">LogitLink</span>(); <span class="co"># optional, defaults to canonical link</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>          nAGQ<span class="op">=</span><span class="fl">1</span>, <span class="co"># optional, default to 1</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>          fast<span class="op">=</span><span class="cn">false</span>, <span class="co"># optional, defaults to false, see the docs for more details.</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>          contrasts,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>          progress<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left;" data-quarto-table-cell-role="th"></td>
<td style="text-align: right;" data-quarto-table-cell-role="th">Est.</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">SE</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">z</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">p</td>
<td style="text-align: right;" data-quarto-table-cell-role="th">σ_dist &amp; urban</td>
</tr>
<tr class="even">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-0.3410</td>
<td style="text-align: right;">0.1265</td>
<td style="text-align: right;">-2.70</td>
<td style="text-align: right;">0.0070</td>
<td style="text-align: right;">0.5683</td>
</tr>
<tr class="odd">
<td style="text-align: left;">urban: Y</td>
<td style="text-align: right;">0.3934</td>
<td style="text-align: right;">0.0853</td>
<td style="text-align: right;">4.61</td>
<td style="text-align: right;">&lt;1e-05</td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">anych: true</td>
<td style="text-align: right;">0.6065</td>
<td style="text-align: right;">0.1045</td>
<td style="text-align: right;">5.80</td>
<td style="text-align: right;">&lt;1e-08</td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">-0.0129</td>
<td style="text-align: right;">0.0112</td>
<td style="text-align: right;">-1.16</td>
<td style="text-align: right;">0.2464</td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">abs2(age)</td>
<td style="text-align: right;">-0.0056</td>
<td style="text-align: right;">0.0008</td>
<td style="text-align: right;">-6.67</td>
<td style="text-align: right;">&lt;1e-10</td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">anych: true &amp; age</td>
<td style="text-align: right;">0.0332</td>
<td style="text-align: right;">0.0128</td>
<td style="text-align: right;">2.59</td>
<td style="text-align: right;">0.0095</td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="limitations-of-mixedmodels.jl" class="level1">
<h1>Limitations of MixedModels.jl</h1>
<p>We expect that MixedModels.jl will generally be best in class for the types of models that it can fit. We use cutting edge algorithms based on penalized least squares and sparse matrix methods that take advantage of the particular sparsity and structure that arises in the case of the linear mixed effects model with an unconstrained covariance structure. Glossing over a fair number of technical details, MixedModels.jl uses a different, novel formulation of the underlying numerical problem which tends to be much more efficient computationally and allows us to fit models with multiple crossed, partially crossed or nested grouping variables without any special treatment.</p>
<section id="very-few-options-for-covariance-structure" class="level2">
<h2 class="anchored" data-anchor-id="very-few-options-for-covariance-structure">Very few options for covariance structure</h2>
<p>Nonetheless, there is no free lunch and the tradeoff that we make is that it is <em>much</em> more difficult to formulate constraints on the covariance structure (whether on the random effects or on the response/residuals) in our formulation. MixedModels.jl currently supports precisely two covariance structures explicitly:</p>
<ol type="1">
<li>unconstrained</li>
<li>zero correlation (diagonal covariance structure)</li>
</ol>
<p>It is also possible to express some models with compound symmetry by clever manipulation of the formula syntax (i.e.&nbsp;<code>(1+c|g)</code> for categorical <code>c</code> with compound symmetry is the same as <code>(1|g) + (1|g&amp;c)</code>).</p>
<p>MixedModels.jl does support constraining the residual variance to known scalar value, which is useful in meta-analysis.</p>
<p><a href="https://github.com/PharmCat/Metida.jl">Metida.jl</a> may provide an alternative if this functionality is required (not an endorsement).</p>
</section>
<section id="no-support-for-sandwichrobust-variance-covariance-estimators" class="level2">
<h2 class="anchored" data-anchor-id="no-support-for-sandwichrobust-variance-covariance-estimators">No support for sandwich/robust variance-covariance estimators</h2>
<p><a href="https://github.com/JuliaStats/MixedModels.jl/pull/768"><em>This may change in the foreseeable future!</em></a></p>
<p>If this would be a valuable feature, then please <a href="https://github.com/JuliaStats/MixedModels.jl/issues/new">file an issue</a>. Issues are prioritized by the developers’ own needs and potential impact for users, so showing a large need for a feature will tend to increase its priority.</p>
<p><a href="https://github.com/FixedEffects/FixedEffectModels.jl">FixedEffectsModels.jl</a> may be a viable alternative (not an endorsement). It provides “fast estimation of linear models with IV and high dimensional categorical variables” and provides similar functionality to Stata’s <code>reghdfe</code> and R’s <code>lfe</code> and <code>fixest</code>.</p>
</section>
<section id="no-support-for-generalized-linear-mixed-models-with-a-dispersion-parameter" class="level2">
<h2 class="anchored" data-anchor-id="no-support-for-generalized-linear-mixed-models-with-a-dispersion-parameter">No support for generalized linear mixed models with a dispersion parameter</h2>
<p>While MixedModels.jl does nominally support any GLM family and link function support by GLM.jl, the results for model families with a dispersion parameter (normal with non-identity link, gamma, inverse Gaussian) are known to be incorrect. The package issues a warning if you attempt to fit such models.</p>
</section>
<section id="no-support-for-polytomous-responses" class="level2">
<h2 class="anchored" data-anchor-id="no-support-for-polytomous-responses">No support for polytomous responses</h2>
<p>Multinomial and ordered responses are not supported. I am unaware of a Julia package offering support for this.</p>
</section>
<section id="no-support-for-regularization-of-the-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="no-support-for-regularization-of-the-fixed-effects">No support for regularization of the fixed effects</h2>
<p><a href="https://github.com/solislemuslab/HighDimMixedModels.jl">HighDimMixedModels.jl</a> may provide an alternative if this functionality is required (not an endorsement).</p>
</section>
<section id="no-support-for-generalized-additive-mixed-models" class="level2">
<h2 class="anchored" data-anchor-id="no-support-for-generalized-additive-mixed-models">No support for generalized additive mixed models</h2>
<p>Generalized additive models can be expressed a mixed model, so supporting this would require “only” adding a translation layer.</p>
</section>
<section id="no-support-for-nonlinear-mixed-effects-models" class="level2">
<h2 class="anchored" data-anchor-id="no-support-for-nonlinear-mixed-effects-models">No support for nonlinear mixed effects models</h2>
<p><a href="https://pumas.ai/our-products/products-suite/pumas">Pumas.jl (commercial)</a> provides this (not an endorsement).</p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-bates:parsimonious:2018" class="csl-entry" role="listitem">
Bates, D., Kliegl, R., Vasishth, S., &amp; Baayen, H. (2018). Parsimonious <span>Mixed</span> <span>Models</span>. <em>arXiv:1506.04967 [Stat]</em>. <a href="http://arxiv.org/abs/1506.04967">http://arxiv.org/abs/1506.04967</a><div class="csl-block">arXiv: 1506.04967</div>
</div>
<div id="ref-harper:2016" class="csl-entry" role="listitem">
Harper, F. M., &amp; Konstan, J. A. (2016). The <span>MovieLens</span> datasets. <em><span>ACM</span> Transactions on Interactive Intelligent Systems</em>, <em>5</em>(4), 1–19. <a href="https://doi.org/10.1145/2827872">https://doi.org/10.1145/2827872</a>
</div>
<div id="ref-huq:cleland:1990" class="csl-entry" role="listitem">
Huq, N. M., &amp; Cleland, J. (1990). <em>Bangladesh fertility survey 1989 (main report)</em>. National Institute of Population Research; Training.
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/palday\.github\.io\/economics2024\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/palday/economics2024/edit/main/01-intro.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/palday/economics2024/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>